{% extends 'basedatatable.html.twig' %}

{% block title %}Instrument {{ instrument.name }}{% endblock %}

{% block body %}
<h1>Instrument {{ instrument.name }}</h1>

<dl class="row">
    <dt class="col-sm-3">Underlying</dt>
    <dd class="col-sm-9">
        <span class="badge bg-secondary">{{ instrument.underlying.symbol }}</span>
        <a href="{{ path('asset_show', {id: instrument.underlying.id}) }}">{{ instrument.underlying.name }}</a> ({{ instrument.underlying.isin }})
    </dd>
    {% if instrument.isin or instrument.issuer %}
    <dt class="col-sm-3">ISIN / Issuer</dt>
    <dd class="col-sm-9"><span>{{ instrument.isin }}</span> / <span>{{ instrument.issuer }}</span></dd>
    {% endif %}
    <dt class="col-sm-3">Class / Status</dt>
    <dd class="col-sm-9">{{ instrument.classname }} / {{ instrument.statusname }}</dd>
    {% if instrument.ratio != 1 %}
    <dt class="col-sm-3">Ratio</dt>
    <dd class="col-sm-9">{{ instrument.ratio }}</dd>
    {% endif %}
    {% if instrument.emissiondate or instrument.terminationdate %}
    <dt class="col-sm-3">Emission | Termination Date</dt>
    <dd class="col-sm-9">
        <span>{% if instrument.emissiondate %}{{ instrument.emissiondate | date("Y-m-d") }}{% else %}N/A{% endif %}</span>
        |
        <span>{% if instrument.terminationdate %}{{ instrument.terminationdate | date("Y-m-d") }}{% else %}N/A{% endif %}</span>
    </dd>
    {% endif %}
    {% if instrument.url %}
    <dt class="col-sm-3">Information</dt>
    <dd class="col-sm-9"><a href="{{ instrument.url }}" target="_blank">{{ instrument.url }}</a></dd>
    {% endif %}
    {% if instrument.notes %}
    <dt class="col-sm-3">Notes</dt>
    <dd class="col-sm-9">{{ instrument.notes | nl2br }}</dd>
    {% endif %}
</dl>

<div class="input-group mb-3">
    <a href="{{ path('instrument_edit', {id: instrument.id}) }}" class="btn btn-primary">Edit</a>
    <a href="{{ path('execution_new', {instrument: instrument.id, direction: 'open'}) }}" class="btn btn-success" data-op="positions" title="Open">Open</a>
    <a href="{{ path('execution_new', {instrument: instrument.id, direction: 'close'}) }}" class="btn btn-danger" data-op="positions" title="Close">Close</a>
    <a href="{{ path('execution_new', {instrument: instrument.id, direction: 'dividend'}) }}" class="btn btn-secondary" data-op="positions" title="Dividend">Dividend</a>
</div>

{% if trades %}
<h2>Trade History</h2>
    <table id="datatable" class="table table-striped">
        <thead>
        <tr>
            <th>Date/Time</th>
            <th>Account</th>
            <th>External Id</th>
            <th>Volume</th>
            <th>Price</th>
            <th>Total</th>
            <th>Costs</th>
            <th>Notes</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
    {% for t in trades %}
        <tr>
        <td>{{t['time'] | date('Y-m-d H:i:s') }}</td>
        <td><a href="#">{{t['accountname']}}</a></td>
        <td>{{t['external_id']}}</td>
        <td class="dt-right" style="{% if t['direction'] > 0 %}color: green{% elseif t['direction'] < 0 %}color: red{% endif %}">
            {% if t['volume'] %} {{t['volume'] | number_format(2)}} {% endif %}
            <span style="float:left" class="{% if t['direction'] > 0 %}bi-box-arrow-in-right{% elseif t['direction'] < 0 %}bi-box-arrow-right{% else %}bi-cash{% endif %}"></span>
        </td>
        <td class="dt-right" data-order="{{t['price']}}">{% if t['price'] %} {{t['price'] | format_currency(instrument.currency)}} {% endif %}</td>
        <td class="dt-right" data-order="{{t['total']}}">{{t['total'] | format_currency(instrument.currency)}}</td>
        <td class="dt-right" data-order="{{t['costs']}}">{% if t['costs'] != 0 %}{{t['costs'] | format_currency(instrument.currency)}}{% endif %}</td>
        <td title="{{t['notes']}}">{{t['notes'] | u.truncate(40, '...')}}</td>
        <td>
            <a href="{{ path('execution_edit', {id: t['transaction']}) }}" class="bi-pencil-square" data-op="edit" title="Edit"></a>&nbsp;
            <a href="#" class="bi-trash" data-op="delete" data-name="{{ t['time'] | date('Y-m-d H:i:s') }}" data-id="{{ path('transaction_delete', {id: t['transaction']}) }}" title="Delete"></a>&nbsp;
        </td>
        </tr>
    {% endfor %}
        </tbody>
        <tfoot>
        <tr>
        <th colspan="3">Total {{ trades | length }} trades</th>
        <th class="dt-right">{{total['volume'] | number_format(2) }}</th>
        <th class="dt-right"></th>
        <th class="dt-right">{{total['value'] | format_currency(instrument.currency)}}</th>
        <th class="dt-right">{{total['costs'] | format_currency(instrument.currency)}}</th>
        <th class="dt-right"></th>
        <th class="dt-right"></th>
        </tr>
        </tfoot>
    </table>
{% endif %}
{% endblock %}

{% block bodyscripts %}
  <script class="init">
        $(document).ready( function () {
            $('#datatable').DataTable({
              "order": [[0, 'desc']]
            });
        } );
  </script>
  <script src="{{ asset('js/formtools.js') }}"></script>
{% endblock %}
