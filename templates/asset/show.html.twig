{% extends 'basedatatable.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="{{ asset('chart.js@3.7', 'jsdelivr') }}"></script>
    <script type="text/javascript" src="{{ asset('moment@2.29', 'jsdelivr') }}"></script>
    <script type="text/javascript" src="{{ asset('chartjs-adapter-moment@1.0', 'jsdelivr') }}"></script>
    <script type="text/javascript" src="{{ asset('hammerjs@2.0', 'jsdelivr') }}"></script>
    <script type="text/javascript" src="{{ asset('chartjs-plugin-zoom@1.2', 'jsdelivr') }}"></script>
    <script type="text/javascript" src="{{ asset('js/chartjs-chart-financial.js') }}" ></script>
{% endblock %}

{% block title %}Asset: {{ asset.name }}{% endblock %}

{% block body %}
<h1>Asset: {{ asset.name }}</h1>

<dl class="row">
    <dd class="col-sm"><div class="fw-bold">Symbol</div><span class="badge bg-secondary">{{ asset.symbol }}</span></dd>
    <dd class="col-sm"><div class="fw-bold">ISIN</div>{{ asset.isin }}</dd>
    <dd class="col-sm"><div class="fw-bold">Type</div>{{ asset.typename }}</dd>
    {% if asset.country %}
    <dd class="col-sm"><div class="fw-bold">Country</div>{{ asset.country | country_name }}</dd>
    {% endif %}
    {% if asset.url %}
    <dd class="col-sm text-truncate"><div class="fw-bold">Information</div><a href="{{ asset.url }}" target="_blank">{{ asset.url }}</a></dd>
    {% endif %}
    {% if price %}
    <dd class="col-sm"><div class="fw-bold">Last price</div>
        {{ price.close | format_currency(asset.currency) }} <small>({{ price.date | date("Y-m-d") }})</small>
    </dd>
    {% endif %}
    {% if asset.notes %}
    <dd class="col-sm-auto"><div class="fw-bold">Notes</div>{{ asset.notes | nl2br }}</dd>
    {% endif %}
</dl>

<div class="input-group mb-3">
    <a href="{{ path('asset_edit', {id: asset.id}) }}" class="btn btn-primary">Edit</a>
    <a href="{{ path('asset_update_prices', {id: asset.id}) }}" class="btn btn-secondary">Update prices</a>
    <a href="{{ path('instrument_new', {underlying: asset.id}) }}" class="btn btn-secondary" title="Create instrument">Create instrument</a>
</div>

<h2>Chart</h2>
<div class="row">
    <div class="col-12">
        <canvas id="price_chart" height="240px"></canvas>
    </div>
</div>

<script>
const chart_options = {
    maintainAspectRatio: false,
    plugins: {
      zoom: {
        pan: {
            enabled: true,
        },
        zoom: {
          wheel: { enabled: true },
          pinch: { enabled: true },
          mode: 'xy',
        }
      }
    }
};
const ctx = document.getElementById('price_chart').getContext('2d');
// TODO: limit time range
const promise_price_data = fetch('{{ path('chart_asset_price', {id: asset.id}) }}').then(data => data.json());
promise_price_data.then(price_data => {
    var myChart = new Chart(ctx, {
        type: 'candlestick',
        data: {
            datasets: [{
                label: '{{asset.symbol}}',
                data: price_data
            }]
        },
        options: chart_options
    });
});
</script>

<h2>Instruments</h2>

<table id="datatable" class="table table-striped">
<thead>
    <tr>
        <th>Name</th><th>ISIN</th><th>Class</th><th>Status</th><th>Termination</th><th>Units</th><th>Value</th>
    </tr>
</thead>
<tbody>
{% set totalunits = 0 %}
{% set totalvalue = 0 %}
{% for inst in instruments %}
<tr>
    <td><a href="{{ path('instrument_show', {id: inst[0].id}) }}" class="link-primary">{{ inst[0].name }}</a></td>
    <td>{{ inst[0].isin }}</td>
    <td>{{ inst[0].classname }}</td>
    <td>{{ inst[0].statusname }}</td>
    <td>{% if inst[0].terminationDate %} {{ inst[0].terminationDate|date("Y-m-d") }}{% endif %}</td>
    <td class="dt-right" data-order="{{ inst.units }}">{% if inst.units %}{{ inst.units | number_format(2) }}{% endif %}</td>
    <td class="dt-right" data-order="{{ inst.totalvalue }}">{% if inst.totalvalue %}{{ inst.totalvalue | format_currency(inst[0].currency) }}{% endif %}</td>
    {% set totalunits = totalunits + inst.units %}
    {% set totalvalue = totalvalue + inst.totalvalue %}
</tr>
{% endfor %}
</tbody>
<tfoot>
<tr>
<td colspan="5"></td>
<td class="dt-right">{{ totalunits | number_format(2) }}</td>
<td class="dt-right">{{ totalvalue | number_format(2) }}</td>
</tr>
</tfoot>
</table>

{% endblock %}
